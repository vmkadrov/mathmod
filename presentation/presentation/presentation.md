---
## Front matter
lang: ru-RU
title: Моделирование движения пучка в электромагнитном поле с помощью GPU
author:
  - Кадров Виктор Максимович
institute:
  - Российский университет дружбы народов, Москва, Россия
date: 16 мая 2025

## i18n babel
babel-lang: russian
babel-otherlangs: english

## Formatting pdf
toc: false
toc-title: Содержание
slide_level: 2
aspectratio: 169
section-titles: true
theme: metropolis
header-includes:
 - \metroset{progressbar=frametitle,sectionpage=progressbar,numbering=fraction}
---


## Введение

В докладе рассматривается подход к моделированию взаимодействия заряженных частиц в пучке. В качестве отправной точки анализируется задача с гравитационным взаимодействием, поскольку она во многом аналогична электрической, но проще для понимания на первом этапе.

## Введение
$$
\left\{
\begin{aligned}
& \dot{\vec{v}}_{i}= G\sum_{j \neq i} \frac{m_j}{||\vec{r}||^3} \vec{r} , \\
& \dot{\vec{x}}_{i} = \vec{v}_{i}, \\
& \vec{x}_{i}(0) = \vec{x}_0, \vec{v}_{i}(0) = \vec{v}_{0},\\
\end{aligned}
\right.
$$
где $\vec{r} = \vec r_i - \vec r_j$ -- радиус-вектор между телами

## Введение
![Пример моделирования гравитационной задачи (Source: Nvidia Developer Guide)](image/grav.png){#fig:001 width=100%}

## Введение
Известно, что даже задача трёх тел в гравитационном взаимодействии не имеет общего аналитического решения, и при увеличении числа тел (N-тел) задача усложняется ещё больше. Однако уже на этом уровне можно выделить два важных аспекта:
1. Наличие члена, обратного к расстоянию в третьей степени, приводит к численным сложностям при моделировании близких взаимодействий.
2. С увеличением числа тел индивидуальные траектории теряют значение, уступая место коллективной динамике всей системы — в данном случае, пучка частиц.

## Замена гравитационного взаимодействия на электрическое

Поскольку в задаче рассматриваются заряженные частицы, гравитационное взаимодействие заменяется на кулоновское. 

$$
\begin{aligned}
& \dot{\vec{v}}_{i}= \frac{1}{4\pi\epsilon_0m_i}\sum_{j \neq i} \frac{q_i q_j}{||\vec{r}||^3} \vec{r} . \\
\end{aligned}
$$
## Замена гравитационного взаимодействия на электрическое
Обозначим теперь $\frac{1}{4\pi\epsilon_0}\sum_{j \neq i} \frac{q_j}{||\vec{r}||^3} \vec{r}$ как $\vec E_s$. Добавим внешнее электрическое ($\vec{E_{ext}}$) и магнитное ($\vec{B}_{ext}$) поле  и получим
$$
\begin{aligned}
& \dot{\vec{v}}_{i}= \frac{q_i}{m_i}(\vec{E}_{s} + \vec E_{ext} +[\vec{v_i}, \vec{B}_{ext}]). \\
\end{aligned}
$$

## Постановка задачи

Таким образом, формулируется следующая задача Коши: заданы начальные положения и скорости частиц, а также известно внешнее по отношению к пучку электромагнитное поле

$$
\left\{
\begin{aligned}
& \dot{\vec{v}}_{i}= \frac{q_i}{m_i}(\vec{E}_{s} + \vec E_{ext} +  [\vec{v_i}, \vec{B}_{ext}]), \\
& \dot{\vec{x}}_{i} = \vec{v}_{i}, \\
& \vec{x}_{i}(0) = \vec{x}_0, \vec{v}_{i}(0) = \vec{v}_{0},\\
\end{aligned}
\right.
$$


Следует отметить, что рассматривается нерелятивистская постановка задачи, и в таком виде она далее и решается.

## Численное решение уравнений движения

Уравнения движения решаются методом конечных разностей

$$
\vec x_{t + 1} = \vec x_t +  F(\vec x_t, \dots)\Delta t
$$

Особое внимание уделяется выбору численной схемы, поскольку на каждом шаге моделирования возникает множество взаимодействий, и даже незначительные численные ошибки могут существенно повлиять на результат.

## Численное решение уравнений движения

В рамках тестирования применялась явная схема Эйлера, однако учитывались её ограничения.

Среди альтернативных схем рассматривается метод Бориса — численная схема второго порядка, обладающая временной обратимостью. Однако он вносит в систему дополнительные силы, отсутствующие в исходной физической постановке, и на релятивистских скоростях эти силы становятся заметными и искажают результат.

## Трудности в расчёте собственного поля

Наибольшие сложности связаны не с решением уравнений движения, а с вычислением собственного поля пучка. Прямое моделирование взаимодействий по схеме "каждый с каждым" (Particle-to-Particle) требует вычислительных затрат порядка $\mathcal{O}(N^2)$, что делает этот подход непрактичным даже при относительно малом числе частиц. Для иллюстрации изображена система из 256 частиц, но в реальных задачах их число может достигать $10^{15}$.

## Трудности в расчёте собственного поля

![Система из 256 частиц с разным зарядом](image/beam.png){#fig:002 width=100%}

## Метод крупных частиц

Одним из способов снижения вычислительной сложности является объединение множества частиц в макрочастицы (Метод крупных частиц).

Для каждой $i$-й макрочастицы пару
$$
(\vec r_i, \vec v_i)
$$ 
можно взять, например, как среднее по микрочастицам.

Тогда, взяв макрочастицу как облако с радиусом $R$ поле вычисляется как
$$
\vec E_s (j \rightarrow i) = \frac{1}{4\pi\epsilon_0}\frac{q_j}{R^3}\vec r,\quad ||\vec r|| < R
$$

## Метод крупных частиц
Кроме того, этот подход позволяет смягчить проблему моделирования близких взаимодействий, так как взаимодействие происходит только при пересечении облаков, то есть когда расстояние между ними меньше $R$. Это позволяет сократить число взаимодействий с $10^{15}$ до, например, $10^9$, что всё ещё является вычислительно затратным. Поэтому на практике чаще применяется другой метод — Particle-In-Cell (PIC).

## Метод Particle-In-Cell

Метод PIC исключает необходимость моделирования парных взаимодействий. Вместо этого рассчитывается распределение заряда на сетке, и далее решается краевая задача для уравнения Пуассона с целью нахождения электрического поля.

## Метод Particle-In-Cell
![PIC](image/pic.png){#fig:003 width=100%}

Именно этот метод чаще всего используется в прикладных задачах. 

## Ускорение расчётов с использованием GPU

Даже при использовании макрочастиц и метода PIC последовательное решение задачи остаётся неприемлемо медленным. Поэтому в современных вычислениях активно применяются графические ускорители (GPU). Они позволяют эффективно распараллелить как решение уравнений движения, так и вычисление собственного поля пучка.

## Ускорение расчётов с использованием GPU

В рамках практической части проекта была разработана архитектура, сочетающая удобство настройки с возможностью высокопроизводительных вычислений

![Схема программного решения](image/nbody.png){#fig:004 width=80%}

## Результаты моделирования
Реализация позволяет моделировать динамику пучка заряженных частиц в электромагнитном поле. Легко моделируются пучки до 200 тыс. частиц и приемлемо -- до 500 тыс.

## Результаты моделирования
![Пучок 100 тыс. частиц на старте симуляции, вектор скорости направлен в катушку](image/start.png){#fig:005 width=100%}
## Результаты моделирования
![Фокусировка пучка](image/mid.png){#fig:006 width=100%}
## Результаты моделирования
![Разлет на выходе из катушки](image/end.png){#fig:007 width=100%}

## Дальнейшая работа

Отдельной задачей остаётся учёт геометрии экспериментальной установки. Даже при её упрощении и грубой дискретизации проблема столкновений частиц становится вычислительно трудоёмкой, особенно при прямом переборе всех возможных пар.

## Дальнейшая работа

Наконец, важным аспектом является правильное использование различных уровней памяти в архитектуре видеокарт NVIDIA

## Дальнейшая работа
![Архитектура памяти GPU](image/memory.png){#fig:008 width=100%} 

## Заключение

Рассмотренная задача моделирования пучков заряженных частиц в электромагнитных полях требует комплексного подхода, сочетающего точные численные методы, эффективную архитектуру программного обеспечения и использование современных вычислительных ресурсов. Несмотря на ряд нерешённых проблем, разработанная архитектура демонстрирует потенциал для дальнейшего развития и внедрения в более сложные модели, включая учёт геометрии установки и использование PIC-методов.